@model LegislacionAPP.Models.AuditoriaCiclosVM
@{
    ViewData["Title"] = "Auditorías";
    string Sub = $"{Model.EmpresaNombre} · {Model.Titulo}";

    //Helpers de nivel CMMI
    int NivelFromPct(decimal pct)
    {
        if (pct >= 90) return 5;
        if (pct >= 80) return 4;
        if (pct >= 60) return 3;
        if (pct >= 40) return 2;
        if (pct > 0) return 1;
        return 0;
    }
    string NombreNivel(int n) => n switch
    {
        5 => "Optimizado",
        4 => "Gestionado cuantitativamente",
        3 => "Definido",
        2 => "Gestionado",
        1 => "Realizado",
        _ => "Incompleto"
    };
    string BadgeNivel(int n) => n switch
    {
        5 => "badge bg-success",             // verde fuerte
        4 => "badge bg-success-subtle text-success-emphasis",
        3 => "badge bg-primary-subtle text-primary-emphasis",
        2 => "badge bg-warning text-dark",
        1 => "badge bg-danger",
        _ => "badge bg-secondary"
    };
}

<!-- Cabecera -->
<div class="page-head rounded-3 shadow-sm p-3 mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h4 mb-1">Auditorías</h1>
            <p class="text-muted mb-0">@Sub</p>
        </div>
        <a asp-controller="Legislacion" asp-action="Index" asp-route-empresaId="@Model.EmpresaID"
           class="btn btn-outline-secondary d-none d-md-inline-flex">Volver</a>
    </div>
</div>

<!-- Alerts -->
@if (TempData["msg"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["msg"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["err"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["err"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- CTA Nueva auditoría -->
<div class="card card-elevated mb-4">
    <div class="card-body d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div>
            <div class="fw-semibold">Crear nueva auditoría</div>
            <div class="text-muted small">Solo puede existir una auditoría abierta por legislación.</div>
        </div>
        <form asp-action="Crear" method="post" class="d-flex align-items-center gap-2">
            @Html.AntiForgeryToken()
            <input type="hidden" name="legislacionId" value="@Model.id_legislacion" />
            <button class="btn btn-primary" @(Model.TieneAbierto ? "disabled" : "")>
                Nueva auditoría
            </button>
            @if (Model.TieneAbierto)
            {
                <span class="badge bg-warning-subtle text-warning-emphasis">
                    Hay una auditoría en curso
                </span>
            }
        </form>
    </div>
</div>

<!-- Tabla / Historial -->
<div class="card card-elevated">
    <div class="card-header bg-transparent border-0 pb-0">
        <h5 class="card-title mb-3">Historial de auditorías</h5>
    </div>

    @if (Model.Ciclos == null || !Model.Ciclos.Any())
    {
        <div class="card-body">
            <div class="text-center text-muted py-4">
                <div class="mb-1">Aún no hay auditorías para esta legislación.</div>
                <div class="small">Crea la primera con el botón “Nueva auditoría”.</div>
            </div>
        </div>
    }
    else
    {
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Estado</th>
                            <th>Inicio</th>
                            <th>Cierre</th>
                            <th style="min-width:220px">Avance</th>

                            <!-- NUEVO: columna CMMI (legislación) -->
                            <th class="text-center" style="width:180px">CMMI</th>

                            <th class="text-end" style="width:200px">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in Model.Ciclos)
                        {
                            var abierto = c.fecha_cierre == null;
                            var estadoClass = abierto ? "bg-primary" : "bg-success";
                            var estadoText = abierto ? "Abierta" : "Cerrada";

                            var pct = c.porcentaje_avance == 0 ? 0 : c.porcentaje_avance;
                            var lvl = c.nivel_cmmi == 0 ? NivelFromPct(pct) : NivelFromPct(pct);

                            <tr class="@(abierto ? "table-warning-subtle" : "")">
                                <td class="text-muted">@c.id_ciclo_auditoria</td>
                                <td><span class="badge @estadoClass">@estadoText</span></td>
                                <td>@c.fecha_inicio.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@(c.fecha_cierre?.ToString("dd/MM/yyyy HH:mm") ?? "—")</td>
                                <td>
                                    <div class="d-flex justify-content-between small text-muted">
                                        <span>@c.articulos_aprobados de @c.articulos_totales</span>
                                        <span>@c.porcentaje_avance %</span>
                                    </div>
                                    <div class="progress progress-thin mt-1" role="progressbar"
                                         aria-valuenow="@c.porcentaje_avance" aria-valuemin="0" aria-valuemax="100">
                                        <div class="progress-bar bg-success" style="width:@c.porcentaje_avance%"></div>
                                    </div>
                                </td>

                                <!-- NUEVO: celda CMMI -->
                                <td class="text-center">
                                    <div class="text-muted">@NombreNivel(lvl)</div>
                                    <div class="text-muted">Nivel @lvl</div>
                                </td>

                                <td class="text-end">
                                    @if (abierto)
                                    {
                                        <a class="btn btn-sm btn-primary"
                                           asp-action="Continuar" asp-route-cicloId="@c.id_ciclo_auditoria">
                                            Continuar
                                        </a>
                                        <form asp-action="Cerrar" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="cicloId" value="@c.id_ciclo_auditoria" />
                                            <button class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('¿Cerrar auditoría?');">
                                                Cerrar
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <a class="btn btn-sm btn-outline-secondary"
                                           asp-action="Continuar" asp-route-cicloId="@c.id_ciclo_auditoria">
                                            Ver
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

<!-- Volver (móvil) -->
<div class="mt-3 d-md-none">
    <a asp-controller="Legislacion" asp-action="Index" asp-route-empresaId="@Model.EmpresaID"
       class="btn btn-outline-secondary w-100">Volver</a>
</div>
