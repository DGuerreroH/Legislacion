@model CMMIReporteVM
@{
    ViewData["Title"] = "Reporte CMMI";

    // Flag server-side para expandir todo (PDF/impresión)
    var q = ViewContext.HttpContext.Request.Query;
    bool ForzarExpandido = (Model?.EsPdf ?? false) || (q.ContainsKey("pdf") && q["pdf"] == "1");

    string BgBadge(decimal pct)
    {
        if (pct >= 75) return "bg-success";
        if (pct >= 50) return "bg-warning text-dark";
        if (pct > 0) return "bg-danger";
        return "bg-secondary";
    }

    string BadgeStyle(decimal pct)
    {
        string bg, fg = "#ffffff", border;
        if (pct >= 75) bg = "#198754";
        else if (pct >= 50) { bg = "#ffc107"; fg = "#212529"; }
        else if (pct > 0) bg = "#dc3545";
        else bg = "#6c757d";
        border = bg;
        return $"background-color:{bg};color:{fg};border:1px solid {border};";
    }
}

<style>
    .metric-card {
        border: 1px solid #e9ecef;
        border-radius: 1rem;
        background: #fff
    }

        .metric-card .big {
            font-size: 2.25rem;
            font-weight: 800;
            line-height: 1
        }

    .q-code {
        background: #eef1f5;
        color: #2b2f33;
        border-radius: .375rem;
        padding: .075rem .5rem;
        font-weight: 600;
        display: inline-block;
        margin-right: .5rem;
        white-space: nowrap;
    }

    .comment-box {
        background: #f8f9fb;
        border-left: 3px solid #e9ecef;
        padding: .7rem .9rem;
        border-radius: .375rem;
    }

    .intro-box {
        background: #f8f9fb;
        border-left: 4px solid #0d6efd;
        padding: 1rem 1.25rem;
        border-radius: .5rem;
    }

    .accordion-button .cat-pct {
        margin-left: auto;
        margin-left: 1.75rem;
    }

    /* Footer (firmas) */
    .report-footer {
        margin-top: 2rem;
        break-inside: avoid;
        page-break-inside: avoid;
    }

        .report-footer .signs {
            display: flex;
            gap: 3rem;
            align-items: flex-end;
            justify-content: space-between;
            break-inside: avoid;
            page-break-inside: avoid;
        }

        .report-footer .sign {
            flex: 1 1 45%;
            text-align: center;
        }

            .report-footer .sign .line {
                border-top: 1px solid #ced4da;
                margin-top: 2.5rem;
                padding-top: .25rem;
                font-weight: 600;
            }

        .report-footer .note {
            margin-top: 1rem;
            font-size: .875rem;
            color: #6c757d;
            text-align: center;
        }

    /* Impresión: sin colapsar y firmas a dos columnas aunque flex falle */
    @@media print {
        .no-print {
            display: none !important;
        }

        .badge {
            background: #fff !important;
            color: #000 !important;
            border: 1px solid #333
        }

        *, .badge {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .report-footer .signs {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        .report-footer .sign {
            display: table-cell;
            width: 50%;
            vertical-align: bottom;
            text-align: center;
        }

        .report-footer .note {
            color: #000;
        }
    }
</style>

<div class="page-head rounded-3 shadow-sm p-3 mb-3 bg-white border">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h5 mb-1">Reporte CMMI — @Model.Empresa</h1>
            <div class="text-muted small">
                Auditor: @Model.Auditor · Inicio: @Model.fecha_inicio ·
                Cierre: @(Model.fecha_cierre?.ToString("dd/MM/yyyy HH:mm") ?? "—")
            </div>
        </div>
        <div class="no-print d-flex gap-2">
            <a asp-action="Index" asp-controller="CMMI" asp-route-empresaId="@Model.id_empresa" class="btn btn-outline-secondary">Volver</a>
            <a class="btn btn-outline-primary" href="?pdf=1">Modo PDF</a>
            <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
        </div>
    </div>
</div>

<!-- Intro -->
<div class="intro-box mb-4">
    Esta auditoría se realizó con base en el modelo <strong>CMMI</strong> (Capability Maturity Model Integration),
    con el objetivo de evaluar el grado de cumplimiento de prácticas y la madurez de los procesos de
    <strong>@Model.Empresa</strong>. El periodo auditado comprende desde <strong>@Model.fecha_inicio</strong>
    hasta <strong>@(Model.fecha_cierre?.ToString("dd/MM/yyyy HH:mm") ?? "—")</strong>, y la evaluación fue
    ejecutada por <strong>@Model.Auditor</strong>. Los resultados incluyen métricas de cumplimiento por categoría,
    detalle por pregunta y comentarios del auditor cuando corresponda.
</div>

<!-- KPIs -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="metric-card p-3 text-center">
            <div class="big">@Model.PorcentajeGlobal.ToString("0.##")%</div>
            <div class="text-muted small">Cumplimiento global</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="metric-card p-3 text-center">
            <div class="big">@Model.NivelGlobal</div>
            <div class="text-muted small">Nivel de madurez</div>
        </div>
    </div>
</div>

<!-- Tabla resumen -->
<div class="table-responsive mb-3">
    <table class="table align-middle">
        <thead class="table-light">
            <tr><th style="width:65%">Categoría</th><th class="text-end">Cumplimiento</th></tr>
        </thead>
        <tbody>
            @foreach (var c in Model.Categorias)
            {
                <tr>
                    <td><div class="fw-semibold">@c.Codigo · @c.Nombre</div></td>
                    <td class="text-end">
                        <span class="badge cat-pct" style="@BadgeStyle(c.Porcentaje)">@($"{c.Porcentaje:0.#}%")</span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<h3 class="h6 mb-2">Detalle por categoría</h3>

@if (!ForzarExpandido)
{
    <!-- Controles solo en modo interactivo -->
    <div class="d-flex gap-2 mb-2 no-print">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-acc-toggle="expand">Expandir todo</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-acc-toggle="collapse">Colapsar todo</button>
    </div>
}

<div class="accordion" id="accCategorias">
    @for (int i = 0; i < Model.Categorias.Count; i++)
    {
        var cat = Model.Categorias[i];
        var cid = $"cat_{i}";

        <div class="accordion-item mb-2 rounded-3 overflow-hidden">
            <h2 class="accordion-header" id="h_@cid">
                @if (ForzarExpandido)
                {
                    <!-- Botón sin comportamiento de collapse y visualmente abierto -->
                    <button class="accordion-button pe-5"
                            type="button"
                            aria-expanded="true"
                            aria-controls="@cid"
                            disabled>
                        <strong>@cat.Codigo</strong> · @cat.Nombre
                        <span class="badge cat-pct" style="@BadgeStyle(cat.Porcentaje)">@($"{cat.Porcentaje:0.#}%")</span>
                    </button>
                }
                else
                {
                    <button class="accordion-button collapsed pe-5"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#@cid"
                            aria-expanded="false"
                            aria-controls="@cid">
                        <strong>@cat.Codigo</strong> · @cat.Nombre
                        <span class="badge cat-pct" style="@BadgeStyle(cat.Porcentaje)">@($"{cat.Porcentaje:0.#}%")</span>
                    </button>
                }
            </h2>

            @if (ForzarExpandido)
            {
                <div id="@cid" class="accordion-collapse collapse show" aria-labelledby="h_@cid" style="height:auto">
                    <div class="accordion-body p-0">
                        @* contenido de la tabla *@
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr><th style="width:55%">Pregunta</th><th class="text-center" style="width:120px">Resultado</th></tr>
                            </thead>
                            <tbody>
                                @foreach (var d in cat.Preguntas)
                                {
                                    <tr>
                                        <td><span class="q-code">@d.Codigo</span>@d.Texto</td>
                                        <td class="text-center"><span class="badge" style="@BadgeStyle(d.Valor)">@($"{d.Valor:0.#}%")</span></td>
                                    </tr>
                                    @if (!string.IsNullOrWhiteSpace(d.Comentario))
                                    {
                                        <tr>
                                            <td colspan="2">
                                                <div class="comment-box">
                                                    <div class="small text-muted mb-1">Comentario del auditor</div>
                                                    @d.Comentario
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
            else
            {
                <div id="@cid" class="accordion-collapse collapse" aria-labelledby="h_@cid">
                    <div class="accordion-body p-0">
                        <table class="table table-sm align-middle mb-0">
                            <thead class="table-light">
                                <tr><th style="width:55%">Pregunta</th><th class="text-center" style="width:120px">Resultado</th></tr>
                            </thead>
                            <tbody>
                                @foreach (var p in cat.Preguntas)
                                {
                                    <tr>
                                        <td><span class="q-code">@p.Codigo</span>@p.Texto</td>
                                        <td class="text-center"><span class="badge" style="@BadgeStyle(p.Valor)">@($"{p.Valor:0.#}%")</span></td>
                                    </tr>
                                    @if (!string.IsNullOrWhiteSpace(p.Comentario))
                                    {
                                        <tr>
                                            <td colspan="2">
                                                <div class="comment-box">
                                                    <div class="small text-muted mb-1">Comentario del auditor</div>
                                                    @p.Comentario
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Pie / Firmas -->
<div class="report-footer">
    <div class="signs">
        <div class="sign">
            <div class="line">Auditor</div>
            <div class="small">@Model.Auditor</div>
        </div>
        <div class="sign">
            <div class="line">Representante de @Model.Empresa</div>
            <div class="small">@Model.RepresentanteEmpresa</div>
        </div>
    </div>
    <div class="note">
        Este informe se emite en el marco de la auditoría basada en el modelo CMMI.
        En caso de hallazgos, se sugiere elaborar e implementar un plan de acción correctiva.
    </div>
</div>

@section Scripts {
    @if (!ForzarExpandido)
    {
        <script>
            document.addEventListener('click', e=>{
              const btn = e.target.closest('[data-acc-toggle]'); if(!btn) return;
              document.querySelectorAll('#accCategorias .accordion-collapse').forEach(el=>{
                const c = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
                if (btn.dataset.accToggle === 'expand') c.show(); else c.hide();
              });
            });
        </script>
    }
}
