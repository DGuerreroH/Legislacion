@model CMMIReporteVM
@{
    ViewData["Title"] = "Reporte CMMI";

    // Muestra solo preguntas con ValorPct < 100 o comentario
    bool SoloHallazgosDefault = true;
           
    string BgBadge(decimal pct)
    {
        if (pct >= 75) return "bg-success";               // verde
        if (pct >= 50) return "bg-warning text-dark";     // amarillo con texto oscuro
        if (pct >  0)  return "bg-danger";                // rojo
        return "bg-secondary";                            // gris
    }

    string BadgeStyle(decimal pct)
    {
        // Colores HEX (Bootstrap 5)
        string bg, fg = "#ffffff", border;
        if (pct >= 75)      bg = "#198754";                // success (verde)
        else if (pct >= 50) { bg = "#ffc107"; fg = "#212529"; } // warning (amarillo + texto oscuro)
        else if (pct > 0)   bg = "#dc3545";                // danger (rojo)
        else                bg = "#6c757d";                // secondary (gris)

        border = bg;
        return $"background-color:{bg};color:{fg};border:1px solid {border};";
    }


}

<style>
    .metric-card {
        border: 1px solid #e9ecef;
        border-radius: 1rem;
        background: #fff
    }

        .metric-card .big {
            font-size: 2.25rem;
            font-weight: 800;
            line-height: 1
        }

    .cat-card {
        border: 1px solid #e9ecef;
        border-radius: 1rem;
        background: #fff;
        overflow: hidden
    }

        .cat-card .card-header {
            background: #fff;
            border-bottom: 1px solid #eef2f6
        }

    .q-code {
        font-weight: 600;
        white-space: nowrap
    }

    .q-chip {
        border-radius: 999px;
        padding: .15rem .5rem;
        font-size: .75rem
    }

    .note {
        background: #f8f9fb;
        border-left: 3px solid #0d6efd;
        padding: .5rem .75rem;
        border-radius: .5rem
    }

    .table > :not(caption) > * > * {
        border-bottom-color: #f1f3f5
    }

    .divider {
        height: 1px;
        background: #eef2f6;
        margin: .75rem 0
    }

    .small-muted {
        font-size: .85rem;
        color: #6c757d
    }
    @@media print {
        .no-print

    {
        display: none !important;
    }
    /* En PDF/impresión, mostrar todo expandido */
    .accordion-button {
        pointer-events: none;
    }

    .accordion-collapse {
        display: block !important;
        visibility: visible !important;
    }

    }

    body {
        background: #fff
    }

    .page-head {
        border: 0;
        box-shadow: none
    }
    /* encabezado del acordeón, badge al extremo derecho */
  .accordion-button .cat-pct{ 
      margin-left:auto;
      margin-left: 1.75rem;
  }

  /* “código” de la pregunta (AST-01, etc.) más discreto */
  .q-code{
    background:#eef1f5; color:#2b2f33; 
    border-radius:.375rem; padding:.075rem .5rem; 
    font-weight:600; display:inline-block; margin-right:.5rem;
  }

  /* caja para comentario grande debajo */
  .comment-box{
    background:#f8f9fb; border-left:3px solid #e9ecef;
    padding:.7rem .9rem; border-radius:.375rem;
  }

  /* PDF/impresión: sin colapsar y con badges legibles */
  @@media print{
    .accordion-button{ pointer-events:none }
    .accordion-collapse{ display:block !important; height:auto !important; visibility:visible !important }
    .accordion-button::after{ display:none }
    .badge{ background:#fff !important; color:#000 !important; border:1px solid #333 }
     *, .badge{
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
  }

  /* Si la vista tiene flag EsPdf desde el servidor, aplica lo mismo */
  @if (Model.EsPdf){
    @: .accordion-button{ pointer-events:none }
    @: .accordion-collapse{ display:block !important; height:auto !important; visibility:visible !important }
    @: .accordion-button::after{ display:none }
    @: .badge{ background:#fff !important; color:#000 !important; border:1px solid #333 }
  }
    
</style>
@functions {
    // Devuelve la clase de Bootstrap del badge según el % (0..100)
    string BadgeFor(decimal pct)
    {
        if (pct >= 75) return "text-bg-success";   // verde
        if (pct >= 50) return "text-bg-warning";   // amarillo
        if (pct > 0) return "text-bg-danger";    // rojo
        return "text-bg-secondary";                // gris (0 o sin datos)
    }
}

<div class="page-head rounded-3 shadow-sm p-3 mb-3 bg-white border">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="h5 mb-1">Reporte CMMI — @Model.Empresa</h1>
            <div class="text-muted small">
                Auditor: @Model.Auditor · Inicio: @Model.fecha_inicio ·
                Cierre: @(Model.fecha_cierre?.ToString("dd/MM/yyyy HH:mm") ?? "—")
            </div>
        </div>
        <div class="no-print d-flex gap-2">
            <a asp-action="Index" asp-controller="CMMI" asp-route-empresaId="@Model.id_empresa"
               class="btn btn-outline-secondary">Volver</a>
            <button class="btn btn-primary" onclick="window.print()">Imprimir</button>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="metric-card p-3 text-center">
            <div class="big">@Model.PorcentajeGlobal.ToString("0.##")%</div>
            <div class="text-muted small">Cumplimiento global</div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="metric-card p-3 text-center">
            <div class="big">@Model.NivelGlobal</div>
            <div class="text-muted small">Nivel de madurez</div>
        </div>
    </div>
</div>


<div class="table-responsive mb-3">
    <table class="table align-middle">
        <thead class="table-light">
            <tr>
                <th style="width:65%">Categoría</th>
                <th class="text-end">Cumplimiento</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in Model.Categorias)
            {
                <tr>
                    <td>
                        <div class="fw-semibold">@c.Codigo · @c.Nombre</div>
                    </td>
                 <td class="text-end">
                    <span class="badge cat-pct" style="@BadgeStyle(c.Porcentaje)">
                        @($"{c.Porcentaje:0.#}%")
                    </span>

                 </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<h3 class="h6 mb-2">Detalle por categoría</h3>

<div class="d-flex gap-2 mb-2 no-print">
    <button type="button" class="btn btn-sm btn-outline-secondary" data-acc-toggle="expand">Expandir todo</button>
    <button type="button" class="btn btn-sm btn-outline-secondary" data-acc-toggle="collapse">Colapsar todo</button>
</div>

<div class="accordion" id="accCategorias">
    @for (int i = 0; i < Model.Categorias.Count; i++)
    {
        var cat = Model.Categorias[i];
        var cid = $"cat_{i}";
        <div class="accordion-item mb-2 rounded-3 overflow-hidden">
              <h2 class="accordion-header" id="h_@cid">
                <button class="accordion-button collapsed pe-5"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#@cid"
                        aria-expanded="false"
                        aria-controls="@cid">
                    <strong>@cat.Codigo</strong> · @cat.Nombre
                    <span class="badge cat-pct" style="@BadgeStyle(cat.Porcentaje)">
                        @($"{cat.Porcentaje:0.#}%")
                    </span>
                </button>
              </h2>

            <div id="@cid" class="accordion-collapse collapse" aria-labelledby="h_@cid">
                <div class="accordion-body p-0">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width:55%">Pregunta</th>
                                <th class="text-center" style="width:120px">Resultado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var q in cat.Preguntas)
                            {
                              <tr>
                                <td>
                                  <span class="q-code">@q.Codigo</span>@q.Texto
                                </td>
                                  <td class="text-center">
                                <span class="badge" style="@BadgeStyle(q.Valor)">
                                  @($"{q.Valor:0.#}%")
                                </span>
                                </td>
                              </tr>
                              @if (!string.IsNullOrWhiteSpace(q.Comentario))
                              {
                                <tr>
                                  <td colspan="2">
                                    <div class="comment-box">
                                      <div class="small text-muted mb-1">Comentario del auditor</div>
                                      @q.Comentario
                                    </div>
                                  </td>
                                </tr>
                              }
                            }
                        </tbody>

                    </table>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('click', e=>{
          const btn = e.target.closest('[data-acc-toggle]'); if(!btn) return;
          const sel = '#accCategorias .accordion-collapse';
          document.querySelectorAll(sel).forEach(el=>{
            const c = bootstrap.Collapse.getOrCreateInstance(el, {toggle:false});
            if (btn.dataset.accToggle === 'expand') c.show(); else c.hide();
          });
        });
    </script>
}